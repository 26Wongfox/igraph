# This file is based on one which was automatically generated by conda-smithy
# and the one in matplotlib.
# It uses conda environment to get the build dependencies for a full windows
# build, both the "normal" one and the msvc based one.

environment:
  
  matrix:
    - TARGET_ARCH: "x64"
      PYTHON_VERSION: "2.7"
      CONDA_INSTALL_LOCN: "C:\\Miniconda-x64"
      VCVARS: C:\Program Files (x86)\Microsoft Visual Studio 9.0\VC\bin\vcvars64.bat
      MSYSTEM: MINGW64
      PATH: C:\msys64\usr\bin;C:\msys64\mingw64\bin;C:\Windows\System32;C:\Windows;%PATH%
    - TARGET_ARCH: "x64"
      PYTHON_VERSION: "3.4"
      CONDA_INSTALL_LOCN: "C:\\Miniconda3-x64"
      VCVARS: C:\Program Files (x86)\Microsoft Visual Studio 10.0\VC\bin\vcvars64.bat
      MSYSTEM: MINGW64
      PATH: C:\msys64\usr\bin;C:\msys64\mingw64\bin;C:\Windows\System32;C:\Windows;%PATH%
    - TARGET_ARCH: "x64"
      PYTHON_VERSION: "3.5"
      CONDA_INSTALL_LOCN: "C:\\Miniconda35-x64"
      VCVARS: C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\bin\vcvars64.bat
      MSYSTEM: MINGW64
      PATH: C:\msys64\usr\bin;C:\msys64\mingw64\bin;C:\Windows\System32;C:\Windows;%PATH%

# We always use a 64-bit machine, but can build x86 distributions
# with the PYTHON_ARCH variable (which is used by CMD_IN_ENV).
platform:
    - x64

init:
  - cmd: "ECHO %PYTHON_VERSION% %CONDA_INSTALL_LOCN%"

install:
    # If there is a newer build queued for the same PR, cancel this one.
    # The AppVeyor 'rollout builds' option is supposed to serve the same
    # purpose but it is problematic because it tends to cancel builds pushed
    # directly to master instead of just PR builds (or the converse).
    # credits: JuliaLang developers.
    - ps: if ($env:APPVEYOR_PULL_REQUEST_NUMBER -and $env:APPVEYOR_BUILD_NUMBER -ne ((Invoke-RestMethod `
        https://ci.appveyor.com/api/projects/$env:APPVEYOR_ACCOUNT_NAME/$env:APPVEYOR_PROJECT_SLUG/history?recordsNumber=50).builds | `
        Where-Object pullRequestId -eq $env:APPVEYOR_PULL_REQUEST_NUMBER)[0].buildNumber) { `
          throw "There are newer queued builds for this pull request, failing early." }

  
    # setup conda environment for building
    - cmd: set "PATH=%CONDA_INSTALL_LOCN%;%CONDA_INSTALL_LOCN%\scripts;%PATH%"
    - cmd: set PYTHONUNBUFFERED=1

    # update mysy2
    - C:\msys64\usr\bin\bash -lc "pacman --needed --noconfirm -Sy pacman-mirrors"
    - C:\msys64\usr\bin\bash -lc "pacman --noconfirm -Sy"
    - C:\msys64\usr\bin\bash -lc "pacman --noconfirm -S autoconf automake bison flex"
    - C:\msys64\usr\bin\bash -lc "pacman --noconfirm -S libxml2-devel zip"

    
    # also install a msvc build environment -> use libxml2 from conda-forge
    - cmd: conda config --add channels conda-forge
    - cmd: conda config --set show_channel_urls yes
    - cmd: conda config --set always_yes true
    - cmd: conda create -n msvc-build-env --quiet libxml2 python=%PYTHON_VERSION%
    - cmd: conda info -a
    
    # Now start with the build: first the msys2 based one
    - cmd: bash bootstrap.sh
    - cmd: bash configure
    # for testing purpose removed, takes ages...
    #- cmd: make

    # now make the msvc builds
    - cmd: make msvc

    # now build the with the right compiler for each python version
    - cmd: set "OLDPATH=%PATH%"
    # conda activate script doesn't like too long PATHs...
    - cmd: set "PATH=%CONDA_INSTALL_LOCN%;%CONDA_INSTALL_LOCN%\scripts;C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem;C:\Windows\System32\WindowsPowerShell\v1.0\"
    - cmd: call activate msvc-build-env
    - cmd: call %VCVARS%
    - cmd: cd igraph-*-msvc
    - cmd: if %PYTHON_VERSION%==2.7 vcbuild.exe /upgrade
    - cmd: if %PYTHON_VERSION%==3.4 VCUpgrade.exe /overwrite igraph.vcproj
    - cmd: if %PYTHON_VERSION%==3.5 devenv.exe  /Upgrade igraph.sln

    # now build it...
    - cmd: if %PYTHON_VERSION%==2.7 vcbuild.exe 'igraph.vcproj', 'release|%TARGET_ARCH%
    - cmd: if %PYTHON_VERSION%==3.4 msbuild.exe igraph.vcxproj
    - cmd: if %PYTHON_VERSION%==3.5 msbuild.exe igraph.vcxproj
    - cmd: cd ..

    - cmd: set "PATH=%OLDPATH%"